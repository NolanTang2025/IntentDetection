<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯äº‘æµ‹è¯•</title>
    <script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/build/wordcloud2.min.js"></script>
    <style>
        body {
            background: #0E1624;
            color: #ECF2F5;
            padding: 2rem;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
        }
        canvas {
            background: #111827;
            border: 1px solid #1F2937;
            border-radius: 12px;
            padding: 1rem;
            margin: 1rem 0;
        }
        .info {
            background: #1F2937;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>è¯äº‘æµ‹è¯•</h1>
        <div class="info">
            <h3>æµ‹è¯•æ•°æ®ï¼š</h3>
            <pre id="testData"></pre>
        </div>
        <canvas id="wordcloud-test" width="600" height="300"></canvas>
        <div class="info">
            <h3>æ¸²æŸ“ç»“æœï¼š</h3>
            <div id="result"></div>
        </div>
    </div>

    <script>
        // æ¨¡æ‹Ÿç”¨æˆ·ç”»åƒæ•°æ®
        const testPortrait = {
            cluster_id: "1",
            characteristics: {
                behavior: "æ·±åº¦ç ”ç©¶",
                urgency: "ä¸­ç´§è¿«",
                stage: "å¯¹æ¯”é˜¶æ®µ",
                product: "F1åå¥½",
                concern: "æœ‰æ•ˆæ€§å¯¼å‘",
                need: "æ­¢é¼¾éœ€æ±‚"
            },
            intent_profile: {
                main_appeal: {
                    "æ­¢é¼¾éœ€æ±‚": 17
                },
                concerns: {
                    "æœ‰æ•ˆæ€§å¯¼å‘": 17
                },
                price_range: {
                    "é«˜ç«¯ä»·å€¼å‹": 17
                }
            },
            product_preferences: {
                "F1åå¥½": 17
            }
        };

        const testInsight = {
            cluster_id: "1",
            user_segment_name: "ğŸ‘ï¸å•æ¬¡æµè§ˆÂ·ä¸­ç´§è¿«",
            key_characteristics: [
                "ç”¨æˆ·è§„æ¨¡: 16 ä¸ªç‹¬ç«‹ç”¨æˆ·ï¼Œ17 ä¸ªæ„å›¾ç‰‡æ®µ",
                "å¹³å‡æµè§ˆæ—¶é•¿: ç¬æ—¶æµè§ˆï¼ˆå•æ¬¡äº¤äº’ï¼‰",
                "å¹³å‡äº¤äº’æ¬¡æ•°: 1.0 æ¬¡",
                "å¹³å‡æ„å›¾å¼ºåº¦: 0.87",
                "è´­ä¹°é˜¶æ®µ: å¯¹æ¯”é˜¶æ®µ",
                "ä»·æ ¼æ•æ„Ÿåº¦: é«˜ç«¯ä»·å€¼å‹",
                "å‚ä¸åº¦: å¿«é€Ÿæµè§ˆè€…",
                "äº§å“åå¥½: F1åå¥½",
                "å…³æ³¨ç‚¹: æœ‰æ•ˆæ€§å¯¼å‘",
                "æ ¸å¿ƒéœ€æ±‚: æ­¢é¼¾éœ€æ±‚"
            ],
            product_recommendations: [
                "ã€ä¸»æ¨äº§å“ã€‘F1åå¥½",
                "é‡ç‚¹å±•ç¤ºF1åå¥½çš„æ ¸å¿ƒåŠŸèƒ½å’Œä¼˜åŠ¿",
                "æä¾›F1åå¥½çš„è¯¦ç»†é¡µé¢ã€è§†é¢‘ã€ç”¨æˆ·è¯„ä»·"
            ]
        };

        // å‡†å¤‡è¯äº‘æ•°æ®
        function prepareWordCloudData(portrait, insight) {
            const words = [];
            
            console.log('å¼€å§‹å‡†å¤‡è¯äº‘æ•°æ®...');
            console.log('Portrait:', portrait);
            console.log('Insight:', insight);
            
            // ä»ç‰¹å¾ä¸­æå–å…³é”®è¯ï¼ˆæƒé‡è¾ƒé«˜ï¼‰
            if (portrait.characteristics) {
                Object.entries(portrait.characteristics).forEach(([key, value]) => {
                    if (value && typeof value === 'string' && value !== 'æœªçŸ¥') {
                        // æ ¹æ®ç‰¹å¾ç±»å‹è®¾ç½®ä¸åŒæƒé‡
                        const weightMap = {
                            'behavior': 50,  // è¡Œä¸ºæ¨¡å¼æœ€é‡è¦
                            'urgency': 45,   // ç´§è¿«åº¦æ¬¡é‡è¦
                            'stage': 40,     // è´­ä¹°é˜¶æ®µ
                            'product': 35,   // äº§å“åå¥½
                            'concern': 30,   // å…³æ³¨ç‚¹
                            'need': 40       // æ ¸å¿ƒéœ€æ±‚
                        };
                        const size = weightMap[key] || 30;
                        words.push({ text: value, size: size });
                        console.log(`æ·»åŠ ç‰¹å¾è¯: ${value} (æƒé‡: ${size})`);
                    }
                });
            }
            
            // ä»æ ¸å¿ƒéœ€æ±‚ä¸­æå–ï¼ˆé«˜æƒé‡ï¼‰
            if (portrait.intent_profile?.main_appeal) {
                Object.keys(portrait.intent_profile.main_appeal).forEach(key => {
                    if (key && key !== 'ç»¼åˆéœ€æ±‚') {
                        words.push({ text: key, size: 45 });
                        console.log(`æ·»åŠ æ ¸å¿ƒéœ€æ±‚: ${key} (æƒé‡: 45)`);
                    }
                });
            }
            
            // ä»å…³æ³¨ç‚¹ä¸­æå–
            if (portrait.intent_profile?.concerns) {
                Object.keys(portrait.intent_profile.concerns).forEach(key => {
                    if (key && key !== 'ç»¼åˆå…³æ³¨') {
                        words.push({ text: key, size: 35 });
                        console.log(`æ·»åŠ å…³æ³¨ç‚¹: ${key} (æƒé‡: 35)`);
                    }
                });
            }
            
            // ä»äº§å“åå¥½ä¸­æå–
            if (portrait.product_preferences) {
                Object.keys(portrait.product_preferences).forEach(key => {
                    if (key && key !== 'å¤šäº§å“æ¯”è¾ƒ' && !key.includes('åå¥½')) {
                        const cleanKey = key.replace('åå¥½', '').trim();
                        if (cleanKey) {
                            words.push({ text: cleanKey, size: 30 });
                            console.log(`æ·»åŠ äº§å“: ${cleanKey} (æƒé‡: 30)`);
                        }
                    } else if (key.includes('åå¥½')) {
                        // æå–äº§å“åç§°ï¼ˆå¦‚"F1åå¥½" -> "F1"ï¼‰
                        const productName = key.replace('åå¥½', '').trim();
                        if (productName) {
                            words.push({ text: productName, size: 30 });
                            console.log(`æ·»åŠ äº§å“å: ${productName} (æƒé‡: 30)`);
                        }
                    }
                });
            }
            
            // ä»ä»·æ ¼åå¥½ä¸­æå–
            if (portrait.intent_profile?.price_range) {
                Object.keys(portrait.intent_profile.price_range).forEach(key => {
                    if (key && key !== 'é«˜ç«¯ä»·å€¼å‹') {
                        words.push({ text: key, size: 25 });
                        console.log(`æ·»åŠ ä»·æ ¼åå¥½: ${key} (æƒé‡: 25)`);
                    }
                });
            }
            
            // ä»ä¸šåŠ¡æ´å¯Ÿä¸­æå–å…³é”®è¯
            if (insight) {
                if (insight.product_recommendations) {
                    insight.product_recommendations.forEach(rec => {
                        const keywords = rec.match(/ã€([^ã€‘]+)ã€‘/g);
                        if (keywords) {
                            keywords.forEach(kw => {
                                const text = kw.replace(/ã€|ã€‘/g, '');
                                words.push({ text: text, size: 20 });
                                console.log(`æ·»åŠ æ¨èå…³é”®è¯: ${text} (æƒé‡: 20)`);
                            });
                        }
                    });
                }
                
                // ä»æ ¸å¿ƒéœ€æ±‚ä¸­æå–
                if (insight.key_characteristics) {
                    insight.key_characteristics.forEach(char => {
                        if (char.includes('æ ¸å¿ƒéœ€æ±‚:')) {
                            const need = char.split('æ ¸å¿ƒéœ€æ±‚:')[1]?.trim();
                            if (need && need !== 'ç»¼åˆéœ€æ±‚') {
                                words.push({ text: need, size: 40 });
                                console.log(`ä»ç‰¹å¾ä¸­æå–æ ¸å¿ƒéœ€æ±‚: ${need} (æƒé‡: 40)`);
                            }
                        }
                        if (char.includes('äº§å“åå¥½:')) {
                            const product = char.split('äº§å“åå¥½:')[1]?.trim();
                            if (product && product !== 'å¤šäº§å“æ¯”è¾ƒ') {
                                const cleanProduct = product.replace('åå¥½', '').trim();
                                if (cleanProduct) {
                                    words.push({ text: cleanProduct, size: 35 });
                                    console.log(`ä»ç‰¹å¾ä¸­æå–äº§å“: ${cleanProduct} (æƒé‡: 35)`);
                                }
                            }
                        }
                        if (char.includes('å…³æ³¨ç‚¹:')) {
                            const concern = char.split('å…³æ³¨ç‚¹:')[1]?.trim();
                            if (concern && concern !== 'ç»¼åˆå…³æ³¨') {
                                words.push({ text: concern, size: 30 });
                                console.log(`ä»ç‰¹å¾ä¸­æå–å…³æ³¨ç‚¹: ${concern} (æƒé‡: 30)`);
                            }
                        }
                    });
                }
            }
            
            // å»é‡å¹¶åˆå¹¶ç›¸åŒè¯çš„æƒé‡
            const wordMap = {};
            words.forEach(w => {
                if (wordMap[w.text]) {
                    wordMap[w.text] = Math.max(wordMap[w.text], w.size); // å–æœ€å¤§å€¼è€Œä¸æ˜¯ç´¯åŠ 
                } else {
                    wordMap[w.text] = w.size;
                }
            });
            
            console.log('è¯äº‘æ•°æ®æ˜ å°„:', wordMap);
            
            // è½¬æ¢ä¸ºè¯äº‘æ ¼å¼ [text, size]ï¼Œç¡®ä¿è‡³å°‘æœ‰ä¸€äº›è¯
            const result = Object.entries(wordMap)
                .filter(([text]) => text && text.length > 0)
                .map(([text, size]) => [text, Math.min(Math.max(size, 15), 60)]);
            
            console.log('æœ€ç»ˆè¯äº‘æ•°æ®:', result);
            
            // å¦‚æœç»“æœä¸ºç©ºï¼Œæ·»åŠ é»˜è®¤è¯
            if (result.length === 0) {
                console.warn('è¯äº‘æ•°æ®ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤è¯');
                return [['ç”¨æˆ·ç”»åƒ', 40], ['æ•°æ®åˆ†æ', 30], ['èšç±»åˆ†æ', 25]];
            }
            
            return result;
        }

        // æ¸²æŸ“è¯äº‘
        function renderWordCloud(canvasId, words) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.error('Canvas not found:', canvasId);
                return;
            }
            
            if (!words || words.length === 0) {
                console.error('Word cloud data is empty');
                canvas.parentElement.innerHTML = '<div style="padding: 40px; text-align: center; color: #8FA0B8;"><p>æš‚æ— è¯äº‘æ•°æ®</p></div>';
                return;
            }
            
            // æ£€æŸ¥WordCloudæ˜¯å¦å¯ç”¨
            if (typeof WordCloud === 'undefined') {
                console.error('WordCloud library not loaded');
                canvas.parentElement.innerHTML = '<div style="padding: 40px; text-align: center; color: #8FA0B8;"><p>è¯äº‘åº“æœªåŠ è½½</p></div>';
                return;
            }
            
            console.log('å¼€å§‹æ¸²æŸ“è¯äº‘ï¼Œæ•°æ®:', words);
            
            // è®¡ç®—é¢‘ç‡èŒƒå›´ï¼Œç”¨äºåŠ¨æ€è°ƒæ•´å­—ä½“å¤§å°
            const frequencies = words.map(w => w[1]);
            const minFreq = Math.min(...frequencies);
            const maxFreq = Math.max(...frequencies);
            const freqRange = maxFreq - minFreq || 1;
            
            console.log('é¢‘ç‡èŒƒå›´:', minFreq, '-', maxFreq);
            
            try {
                WordCloud(canvas, {
                    list: words,
                    gridSize: Math.round(16 * 600 / 1024),
                    weightFactor: function(size) {
                        // æ ¹æ®é¢‘ç‡èŒƒå›´åŠ¨æ€è°ƒæ•´å­—ä½“å¤§å°
                        const normalizedFreq = (size - minFreq) / freqRange;
                        const normalizedSize = Math.sqrt(normalizedFreq);
                        
                        const minFontSize = 12;
                        const maxFontSize = 60;
                        const fontSize = minFontSize + normalizedSize * (maxFontSize - minFontSize);
                        
                        return fontSize;
                    },
                    fontFamily: 'Arial, "Microsoft YaHei", sans-serif',
                    color: function() {
                        const colors = ['#7FE8C1', '#7DA6FF', '#A78BFA', '#F472B6', '#60A5FA', '#34D399', '#FBBF24'];
                        return colors[Math.floor(Math.random() * colors.length)];
                    },
                    rotateRatio: 0.3,
                    rotationSteps: 2,
                    backgroundColor: 'transparent',
                    minSize: 12,
                    drawOutOfBound: false
                });
                console.log('è¯äº‘æ¸²æŸ“æˆåŠŸ');
                document.getElementById('result').innerHTML = '<p style="color: #7FE8C1;">âœ“ è¯äº‘æ¸²æŸ“æˆåŠŸï¼</p>';
            } catch (e) {
                console.error('Error rendering word cloud:', e);
                document.getElementById('result').innerHTML = `<p style="color: #FB7185;">âœ— æ¸²æŸ“å¤±è´¥: ${e.message}</p>`;
            }
        }

        // æ˜¾ç¤ºæµ‹è¯•æ•°æ®
        document.getElementById('testData').textContent = JSON.stringify({
            portrait: testPortrait,
            insight: testInsight
        }, null, 2);

        // æµ‹è¯•è¯äº‘
        window.addEventListener('load', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹æµ‹è¯•è¯äº‘...');
            const wordCloudData = prepareWordCloudData(testPortrait, testInsight);
            console.log('å‡†å¤‡çš„æ•°æ®:', wordCloudData);
            renderWordCloud('wordcloud-test', wordCloudData);
        });
    </script>
</body>
</html>

